<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formula Key Operation File</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }
        thead th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tfoot tr {
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style untuk heatmap */
        .heatmap-cell {
            transition: transform 0.2s ease-in-out;
        }
        .heatmap-cell:hover {
            transform: scale(1.1);
            z-index: 20;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            border-radius: 4px;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Formula Key Operation File</h1>
            <p class="text-md text-gray-600 mt-2">Unggah file CSV atau Excel Anda. Semua sheet dalam file Excel akan diproses.</p>
        </header>

        <!-- Panel Kontrol -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                <div class="space-y-4 md:col-span-2">
                    <div>
                        <label for="dataFile" class="block text-sm font-medium text-gray-700 mb-1">Unggah File Data Anda (.csv, .xls, .xlsx)</label>
                        <input type="file" id="dataFile" accept=".csv, .xls, .xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 transition-colors duration-200">
                    </div>
                </div>
                
                <div class="flex items-center justify-start">
                    <button id="processBtn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105 duration-200">
                        Proses Data
                    </button>
                    <div id="loader" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8 ml-4 hidden"></div>
                </div>
            </div>
             <div id="error-message" class="text-red-500 mt-4 text-sm font-medium hidden"></div>
        </div>

        <!-- Hasil Analisis -->
        <div id="results" class="hidden">
            <!-- Panel Filter -->
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                 <h3 class="text-xl font-semibold mb-4 text-gray-800">Filter Data</h3>
                 <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                     <div>
                         <label for="searchNama" class="block text-sm font-medium text-gray-700">Nama</label>
                         <input type="text" id="searchNama" placeholder="Cari berdasarkan nama..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                     </div>
                     <div>
                         <label for="searchTanggalMulai" class="block text-sm font-medium text-gray-700">Tanggal Mulai</label>
                         <input type="date" id="searchTanggalMulai" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                     </div>
                     <div>
                         <label for="searchTanggalSelesai" class="block text-sm font-medium text-gray-700">Tanggal Selesai</label>
                         <input type="date" id="searchTanggalSelesai" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                     </div>
                     <div>
                         <label for="searchSumber" class="block text-sm font-medium text-gray-700">Sumber</label>
                         <select id="searchSumber" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            <option value="">Semua Sumber</option>
                            <option value="MANUAL">MANUAL</option>
                            <option value="TIKET">TIKET</option>
                         </select>
                     </div>
                     <div class="flex items-end space-x-2">
                         <button id="searchBtn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200">Cari</button>
                         <button id="resetBtn" class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-all duration-200">Reset</button>
                     </div>
                 </div>
            </div>

            <!-- Heatmap Container -->
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Heatmap Jumlah Transaksi ADM per Nama (Top 50)</h3>
                <p class="text-sm text-gray-500 mb-4">Bagan ini menampilkan data keseluruhan dan tidak terpengaruh oleh filter di atas. Warna sel merepresentasikan jumlah transaksi.</p>
                <div id="heatmapContainer" class="table-container border rounded-lg">
                    <!-- Heatmap akan dirender di sini oleh JavaScript -->
                </div>
            </div>

            <!-- Tabel Rekapitulasi Dana -->
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Ringkasan Dana per Nama (Sesuai Filter)</h3>
                    <span id="rekapDanaCount" class="text-sm font-medium text-gray-500"></span>
                </div>
                <div class="table-container border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Nama</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-bold text-gray-800 uppercase tracking-wider">Total Rupiah (Rp)</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-bold text-purple-600 uppercase tracking-wider">Total Nominal Tiket</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-bold text-red-600 uppercase tracking-wider">Total ADM (Rp)</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-bold text-orange-600 uppercase tracking-wider">Komisi Konter (20%)</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-bold text-teal-600 uppercase tracking-wider">Komisi CS (10%)</th>
                            </tr>
                        </thead>
                        <tbody id="rekapDanaTableBody"></tbody>
                        <tfoot id="rekapDanaTableFoot" class="bg-gray-100 font-bold"></tfoot>
                    </table>
                </div>
            </div>
            
            <!-- Tabel Rincian ADM -->
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Rincian Biaya Admin per Nama (Sesuai Filter)</h3>
                    <span id="rekapAdmCount" class="text-sm font-medium text-gray-500"></span>
                </div>
                <div class="table-container border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead id="rekapAdmTableHead" class="bg-gray-50"></thead>
                        <tbody id="rekapAdmTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                        <tfoot id="rekapAdmTableFoot" class="bg-gray-100 font-bold"></tfoot>
                    </table>
                </div>
            </div>
            
            <!-- Tabel Data Lengkap -->
             <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Detail Transaksi (Sesuai Filter)</h3>
                    <span id="fullDataCount" class="text-sm font-medium text-gray-500"></span>
                </div>
                <div class="table-container border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Tanggal</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Nama</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Keterangan</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">Jumlah (Rp)</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-bold text-purple-600 uppercase tracking-wider">Nominal Tiket</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-bold text-red-600 uppercase tracking-wider">ADM (Rp)</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Sumber</th>
                            </tr>
                        </thead>
                        <tbody id="fullDataTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Welcome Message -->
        <div id="welcome" class="text-center py-12">
             <div class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto">
                <svg class="mx-auto h-12 w-12 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                </svg>
                <h2 class="mt-4 text-2xl font-bold text-gray-900">Selamat Datang!</h2>
                <p class="mt-2 text-gray-600">Silakan unggah file CSV atau Excel Anda untuk memulai analisis.</p>
             </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elemen DOM ---
            const dataFileInput = document.getElementById('dataFile');
            const processBtn = document.getElementById('processBtn');
            const searchBtn = document.getElementById('searchBtn');
            const resetBtn = document.getElementById('resetBtn');
            const searchNamaInput = document.getElementById('searchNama');
            const searchTanggalMulaiInput = document.getElementById('searchTanggalMulai');
            const searchTanggalSelesaiInput = document.getElementById('searchTanggalSelesai');
            const searchSumberInput = document.getElementById('searchSumber');
            const rekapDanaTableBody = document.getElementById('rekapDanaTableBody');
            const rekapDanaTableFoot = document.getElementById('rekapDanaTableFoot');
            const rekapAdmTableHead = document.getElementById('rekapAdmTableHead');
            const rekapAdmTableBody = document.getElementById('rekapAdmTableBody');
            const rekapAdmTableFoot = document.getElementById('rekapAdmTableFoot');
            const fullDataTableBody = document.getElementById('fullDataTableBody');
            const rekapDanaCountEl = document.getElementById('rekapDanaCount');
            const rekapAdmCountEl = document.getElementById('rekapAdmCount');
            const fullDataCountEl = document.getElementById('fullDataCount');
            const resultsDiv = document.getElementById('results');
            const welcomeDiv = document.getElementById('welcome');
            const loader = document.getElementById('loader');
            const errorMessage = document.getElementById('error-message');
            const heatmapContainer = document.getElementById('heatmapContainer');

            // --- State Aplikasi ---
            let fullData = [];

            // --- Fungsi Utilitas ---
            const showError = (message) => {
                errorMessage.textContent = message;
                errorMessage.classList.remove('hidden');
            };
            const hideError = () => errorMessage.classList.add('hidden');
            const formatRupiah = (number) => new Intl.NumberFormat('id-ID').format(number);
            
            // --- Logika Pengolahan Data ---

            const parseFile = (file) => {
                return new Promise((resolve, reject) => {
                    const fileName = file.name.toLowerCase();
                    if (fileName.endsWith('.csv')) {
                        Papa.parse(file, {
                            header: false, skipEmptyLines: true, delimiter: ';',
                            complete: (results) => results.errors.length > 0 ? reject(new Error('Gagal parsing CSV.')) : resolve(results.data.slice(1)),
                            error: (err) => reject(err)
                        });
                    } else if (fileName.endsWith('.xls') || fileName.endsWith('.xlsx')) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            try {
                                const data = event.target.result;
                                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                                let allRows = [];
                                workbook.SheetNames.forEach(sheetName => {
                                    const worksheet = workbook.Sheets[sheetName];
                                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false });
                                    allRows = allRows.concat(jsonData.slice(1));
                                });
                                resolve(allRows);
                            } catch (e) { reject(new Error("Gagal membaca file Excel.")); }
                        };
                        reader.onerror = (error) => reject(error);
                        reader.readAsArrayBuffer(file);
                    } else {
                        reject(new Error('Format file tidak didukung.'));
                    }
                });
            };

            const calculateAdmTartun = (keterangan, jumlah) => {
                const ket = keterangan.toUpperCase();
                const hasTimePattern = /TARTUN\s\d{1,2}:\d{2}/.test(ket);

                if (ket.includes("QR") || hasTimePattern) {
                    if (jumlah < 200000) return 3000;
                    if (jumlah < 500000) return 5000;
                    if (jumlah < 1000000) return 10000;
                    if (jumlah < 1500000) return 15000;
                    if (jumlah < 2000000) return 20000;
                    if (jumlah < 2500000) return 25000;
                    if (jumlah < 3000000) return 30000;
                    if (jumlah < 3500000) return 35000;
                    if (jumlah < 4000000) return 40000;
                    if (jumlah < 4500000) return 45000;
                    if (jumlah < 5000000) return 50000;
                    if (jumlah < 5500000) return 55000;
                    if (jumlah < 6000000) return 60000;
                    if (jumlah < 6500000) return 65000;
                    if (jumlah < 7000000) return 70000;
                    if (jumlah < 7500000) return 75000;
                    if (jumlah < 8000000) return 80000;
                    if (jumlah < 8500000) return 85000;
                    if (jumlah < 9000000) return 90000;
                    if (jumlah < 9500000) return 95000;
                    if (jumlah < 10000000) return 100000;
                    return 0;
                } else if (ket.includes("TF") || ket.includes("TIKET DEPOSIT")) {
                    if (jumlah < 203999) return 3000;
                    if (jumlah < 5005999) return 5000;
                    if (jumlah < 10010999) return 10000;
                    if (jumlah < 20020999) return 20000;
                    if (jumlah < 50025999) return 25000;
                    return 0;
                }
                return 0;
            };

            const normalizeName = (name) => {
                const upperName = name.trim().toUpperCase().replace(/\s+/g, ' ');
                const rules = [
                    { base: 'PLC ALFA6 CINANGKA', variants: ['PLC ALFA6 CINANGKA', 'PLC ALFA6'] }, { base: 'PLC ALFA5 NAGROG1', variants: ['PLC ALFA5 NAGROG1'] },
                    { base: 'PLC PC3 CJM', variants: ['PLC PC3 CJM'] }, { base: 'PLC ALFA4 PARAKAN', variants: ['PLC ALFA4 PARAKAN'] },
                    { base: 'PLC BUNISARI', variants: ['PLC BUNISARI'] }, { base: 'PLC ALFA2 SINJAY2', variants: ['PLC ALFA2 SINJAY2'] },
                    { base: 'PLC ALFA7 CINGISED', variants: ['PLC ALFA7 CINGISED'] }, { base: 'PLC SA', variants: ['PLC SA'] },
                    { base: 'PLC RK', variants: ['PLC RK'] }, { base: 'PLC SS', variants: ['PLC SS'] }
                ];
                for (const rule of rules) {
                    const matchingVariant = rule.variants.sort((a, b) => b.length - a.length).find(variant => upperName.startsWith(variant));
                    if (matchingVariant) return rule.base;
                }
                return name.trim();
            };

            const cleanData = (data) => {
                return data.map((row) => {
                    if (!row || row.length < 4) return null;
                    const tglData = row[0];
                    const namaStr = String(row[1] || '').trim();
                    const ketStr = String(row[2] || '').trim();
                    
                    if (ketStr.toUpperCase().includes('ADM TARTUN TIKET')) {
                        return null;
                    }

                    const jumlahStr = String(row[3] || '0');
                    const finalNama = normalizeName(namaStr);
                    const jumlah = parseInt(jumlahStr.replace(/\D/g, ''), 10) || 0;
                    const admTartun = calculateAdmTartun(ketStr, jumlah);
                    const sumber = ketStr.toUpperCase().includes('TIKET') ? 'TIKET' : 'MANUAL';
                    const nominalTiket = sumber === 'TIKET' ? jumlah % 1000 : 0;

                    let tanggal = null;
                    let originalTanggalStr = '';
                    
                    if (tglData instanceof Date && !isNaN(tglData)) {
                        const year = tglData.getFullYear();
                        const month = tglData.getMonth();
                        const day = tglData.getDate();
                        const hours = tglData.getHours();
                        const minutes = tglData.getMinutes();
                        tanggal = new Date(Date.UTC(year, month, day));
                        originalTanggalStr = `${String(day).padStart(2,'0')}/${String(month+1).padStart(2,'0')}/${year} ${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}`;
                    } else if (typeof tglData === 'string' && tglData.trim()) {
                        originalTanggalStr = tglData.trim();
                        const datePart = originalTanggalStr.split(' ')[0];
                        const parts = datePart.split(/[-/]/);
                        if (parts.length === 3) {
                            let day, month, year;
                            const part1 = parseInt(parts[0], 10);
                            const part2 = parseInt(parts[1], 10);
                            let yearPart = parseInt(parts[2], 10);
                            
                            if (part1 > 12) { day = part1; month = part2; } 
                            else if (part2 > 12) { month = part1; day = part2; } 
                            else { day = part1; month = part2; }
                            
                            if (String(yearPart).length === 2) year = yearPart + 2000;
                            else year = yearPart;

                            if (day && month && year && !isNaN(day) && !isNaN(month) && !isNaN(year)) {
                                tanggal = new Date(Date.UTC(year, month - 1, day));
                            }
                        }
                    }
                    
                    if (!tanggal || isNaN(tanggal.getTime()) || !finalNama || !ketStr) return null;
                    return { Tanggal: tanggal, OriginalTanggal: originalTanggalStr, Nama: finalNama, Keterangan: ketStr, Jumlah: jumlah, AdmTartun: admTartun, NominalTiket: nominalTiket, Sumber: sumber };
                }).filter(row => row !== null);
            };
            
            const createDanaRekap = (data) => {
                const rekapMap = new Map();
                data.forEach(row => {
                    const key = row.Nama.trim().toUpperCase();
                    if (!key) return;
                    if (!rekapMap.has(key)) {
                        rekapMap.set(key, { Nama: row.Nama.trim(), TotalRp: 0, TotalAdm: 0, TotalNominalTiket: 0, KomisiKonter: 0, KomisiCs: 0 });
                    }
                    const entry = rekapMap.get(key);
                    const totalAdmRow = row.AdmTartun + row.NominalTiket;
                    const komisiKonterRow = totalAdmRow * 0.20;
                    const komisiCsRow = komisiKonterRow * 0.10;

                    entry.TotalRp += row.Jumlah;
                    entry.TotalAdm += totalAdmRow;
                    entry.TotalNominalTiket += row.NominalTiket;
                    entry.KomisiKonter += komisiKonterRow;
                    entry.KomisiCs += komisiCsRow;
                });
                return Array.from(rekapMap.values()).sort((a, b) => b.TotalAdm - a.TotalAdm);
            };

            const createAdmCountRekap = (data) => {
                const rekapMap = new Map();
                const admFeeTypes = new Set([0]);
                data.forEach(row => {
                    admFeeTypes.add(row.AdmTartun);
                });
                const sortedAdmFees = [...admFeeTypes].sort((a, b) => a - b);

                data.forEach(row => {
                    const key = row.Nama.trim().toUpperCase();
                    if (!key) return;
                    if (!rekapMap.has(key)) {
                        const newEntry = { Nama: row.Nama.trim(), JmlManual: 0, JmlTiket: 0, JmlTransaksi: 0, admCounts: {} };
                        sortedAdmFees.forEach(fee => newEntry.admCounts[fee] = 0);
                        rekapMap.set(key, newEntry);
                    }
                    const entry = rekapMap.get(key);
                    entry.JmlTransaksi += 1;
                    if (row.Sumber === 'MANUAL') entry.JmlManual += 1;
                    else if (row.Sumber === 'TIKET') entry.JmlTiket += 1;
                    entry.admCounts[row.AdmTartun]++;
                });
                return { data: Array.from(rekapMap.values()).sort((a, b) => b.JmlTransaksi - a.JmlTransaksi), admFeeTypes: sortedAdmFees };
            };

            // --- Logika Tampilan (UI) ---

            const renderDanaRekapTable = (data) => {
                let html = '';
                rekapDanaTableFoot.innerHTML = '';
                if (data.length === 0) {
                    rekapDanaTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-gray-500">Tidak ada data untuk ditampilkan.</td></tr>`;
                } else {
                    const totals = data.reduce((acc, row) => {
                        acc.TotalRp += row.TotalRp; acc.TotalAdm += row.TotalAdm;
                        acc.TotalNominalTiket += row.TotalNominalTiket;
                        acc.KomisiKonter += row.KomisiKonter;
                        acc.KomisiCs += row.KomisiCs;
                        return acc;
                    }, { TotalRp: 0, TotalAdm: 0, TotalNominalTiket: 0, KomisiKonter: 0, KomisiCs: 0 });

                    data.forEach(row => {
                        html += `
                            <tr class="hover:bg-gray-50 transition-colors duration-150">
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${row.Nama}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 text-right">${formatRupiah(row.TotalRp)}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-purple-700 text-right">${formatRupiah(row.TotalNominalTiket)}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-red-700 text-right">${formatRupiah(row.TotalAdm)}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-orange-700 text-right">${formatRupiah(row.KomisiKonter)}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-teal-700 text-right">${formatRupiah(row.KomisiCs)}</td>
                            </tr>
                        `;
                    });
                    rekapDanaTableBody.innerHTML = html;

                    rekapDanaTableFoot.innerHTML = `
                        <tr class="border-t-2 border-gray-300">
                            <td class="px-4 py-3 text-sm text-gray-900">TOTAL</td>
                            <td class="px-4 py-3 text-sm text-gray-900 text-right">${formatRupiah(totals.TotalRp)}</td>
                            <td class="px-4 py-3 text-sm text-purple-700 text-right font-bold">${formatRupiah(totals.TotalNominalTiket)}</td>
                            <td class="px-4 py-3 text-sm text-red-700 text-right font-bold">${formatRupiah(totals.TotalAdm)}</td>
                            <td class="px-4 py-3 text-sm text-orange-700 text-right font-bold">${formatRupiah(totals.KomisiKonter)}</td>
                            <td class="px-4 py-3 text-sm text-teal-700 text-right font-bold">${formatRupiah(totals.KomisiCs)}</td>
                        </tr>
                    `;
                }
                rekapDanaCountEl.textContent = `Menampilkan rekap dana untuk ${data.length} nama`;
            };

            const renderAdmCountTable = (rekapResult) => {
                const { data, admFeeTypes } = rekapResult;
                let headerHtml = '<tr><th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Nama</th>';
                admFeeTypes.forEach(fee => {
                    const label = fee === 0 ? "Tanpa ADM" : `ADM ${formatRupiah(fee)}`;
                    headerHtml += `<th scope="col" class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">${label}</th>`;
                });
                headerHtml += `
                    <th scope="col" class="px-4 py-3 text-center text-xs font-bold text-blue-600 uppercase tracking-wider">Jml MANUAL</th>
                    <th scope="col" class="px-4 py-3 text-center text-xs font-bold text-green-600 uppercase tracking-wider">Jml TIKET</th>
                    <th scope="col" class="px-4 py-3 text-center text-xs font-bold text-gray-800 uppercase tracking-wider">Total Transaksi</th>
                </tr>`;
                rekapAdmTableHead.innerHTML = headerHtml;

                let bodyHtml = '';
                rekapAdmTableFoot.innerHTML = '';
                if (data.length === 0) {
                    const colspan = admFeeTypes.length + 4;
                    rekapAdmTableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center py-8 text-gray-500">Tidak ada data untuk ditampilkan.</td></tr>`;
                } else {
                    const totals = { JmlManual: 0, JmlTiket: 0, JmlTransaksi: 0, admCounts: {} };
                    admFeeTypes.forEach(fee => totals.admCounts[fee] = 0);

                    data.forEach(row => {
                        totals.JmlManual += row.JmlManual;
                        totals.JmlTiket += row.JmlTiket;
                        totals.JmlTransaksi += row.JmlTransaksi;
                        
                        bodyHtml += `<tr class="hover:bg-gray-50 transition-colors duration-150"><td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${row.Nama}</td>`;
                        admFeeTypes.forEach(fee => {
                            const count = row.admCounts[fee] || 0;
                            totals.admCounts[fee] += count;
                            bodyHtml += `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 text-center">${count}</td>`;
                        });
                        bodyHtml += `
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-blue-700 text-center">${row.JmlManual}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-green-700 text-center">${row.JmlTiket}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 text-center font-bold">${row.JmlTransaksi}</td>
                        </tr>`;
                    });
                    rekapAdmTableBody.innerHTML = bodyHtml;

                    let footerHtml = `<tr class="border-t-2 border-gray-300"><td class="px-4 py-3 text-sm text-gray-900">TOTAL</td>`;
                    admFeeTypes.forEach(fee => {
                        footerHtml += `<td class="px-4 py-3 text-sm text-gray-900 text-center font-bold">${totals.admCounts[fee]}</td>`;
                    });
                    footerHtml += `
                        <td class="px-4 py-3 text-sm text-blue-700 text-center font-bold">${totals.JmlManual}</td>
                        <td class="px-4 py-3 text-sm text-green-700 text-center font-bold">${totals.JmlTiket}</td>
                        <td class="px-4 py-3 text-sm text-gray-800 text-center font-bold">${totals.JmlTransaksi}</td>
                    </tr>`;
                    rekapAdmTableFoot.innerHTML = footerHtml;
                }
                rekapAdmCountEl.textContent = `Menampilkan rincian untuk ${data.length} nama`;
            };

            const renderDetailTable = (data) => {
                let html = '';
                 if (data.length === 0) {
                    html = `<tr><td colspan="7" class="text-center py-8 text-gray-500">Tidak ada data transaksi untuk ditampilkan.</td></tr>`;
                } else {
                    data.forEach(row => {
                        const sourceClass = row.Sumber === 'MANUAL' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800';
                        const nominalTiketDisplay = row.Sumber === 'TIKET' ? row.NominalTiket : '-';
                        html += `
                            <tr class="hover:bg-gray-50 transition-colors duration-150">
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${row.OriginalTanggal}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${row.Nama}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${row.Keterangan}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 text-right">${formatRupiah(row.Jumlah)}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-purple-700 text-right font-medium">${nominalTiketDisplay}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-red-700 text-right">${formatRupiah(row.AdmTartun)}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${sourceClass}">${row.Sumber}</span></td>
                            </tr>
                        `;
                    });
                }
                fullDataTableBody.innerHTML = html;
                fullDataCountEl.textContent = `Menampilkan ${data.length} dari total ${fullData.length} transaksi`;
            };
            
            const renderAdmHeatmap = (data) => {
                const { admFeeTypes, data: rekapData } = createAdmCountRekap(data);
                const sortedRekapData = rekapData.sort((a,b) => b.JmlTransaksi - a.JmlTransaksi).slice(0, 50);
                
                const heatmapAdmFeeTypes = admFeeTypes.filter(fee => fee > 0);

                let maxCount = 0;
                sortedRekapData.forEach(row => {
                    heatmapAdmFeeTypes.forEach(fee => {
                        const count = row.admCounts[fee] || 0;
                        if (count > maxCount) maxCount = count;
                    });
                });

                const getColorForValue = (value, max) => {
                    if (value === 0) return 'bg-gray-100';
                    const intensity = Math.min(Math.floor((value / max) * 8) + 1, 9);
                    return `bg-blue-${intensity * 100}`;
                };

                let tableHtml = '<table class="min-w-full divide-y divide-gray-200">';
                let headerHtml = '<thead class="bg-gray-50"><tr><th class="px-2 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Nama</th>';
                heatmapAdmFeeTypes.forEach(fee => {
                    headerHtml += `<th class="px-2 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider" title="Biaya Admin ${formatRupiah(fee)}">${formatRupiah(fee)}</th>`;
                });
                headerHtml += '</tr></thead>';
                tableHtml += headerHtml;

                let bodyHtml = '<tbody class="bg-white divide-y divide-gray-200">';
                sortedRekapData.forEach(row => {
                    bodyHtml += `<tr><td class="px-2 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${row.Nama}</td>`;
                    heatmapAdmFeeTypes.forEach(fee => {
                        const count = row.admCounts[fee] || 0;
                        const colorClass = getColorForValue(count, maxCount);
                        const textColor = count > maxCount / 2 ? 'text-white' : 'text-gray-800';
                        bodyHtml += `<td title="${row.Nama} - ADM ${formatRupiah(fee)}: ${count} transaksi" class="heatmap-cell text-center p-2 text-sm font-semibold ${colorClass} ${textColor}">${count > 0 ? count : ''}</td>`;
                    });
                    bodyHtml += '</tr>';
                });
                bodyHtml += '</tbody>';
                tableHtml += bodyHtml;
                heatmapContainer.innerHTML = tableHtml;
            };

            const runFilterAndRender = () => {
                const namaQuery = searchNamaInput.value.toLowerCase().trim();
                const tanggalMulaiQuery = searchTanggalMulaiInput.value;
                const tanggalSelesaiQuery = searchTanggalSelesaiInput.value;
                const sumberQuery = searchSumberInput.value;

                let filteredData = fullData;

                if (tanggalMulaiQuery || tanggalSelesaiQuery) {
                    const startUTC = tanggalMulaiQuery ? new Date(tanggalMulaiQuery).getTime() : -Infinity;
                    const endUTC = tanggalSelesaiQuery ? new Date(tanggalSelesaiQuery).getTime() + (24 * 60 * 60 * 1000 - 1) : Infinity;
                    filteredData = filteredData.filter(row => {
                        const rowTime = row.Tanggal.getTime();
                        return rowTime >= startUTC && rowTime <= endUTC;
                    });
                }

                if (namaQuery) {
                    filteredData = filteredData.filter(row => row.Nama.toLowerCase().includes(namaQuery));
                }

                if (sumberQuery) {
                    filteredData = filteredData.filter(row => row.Sumber === sumberQuery);
                }
                
                const danaRekapData = createDanaRekap(filteredData);
                const admCountRekapData = createAdmCountRekap(filteredData);

                renderDanaRekapTable(danaRekapData);
                renderAdmCountTable(admCountRekapData);
                renderDetailTable(filteredData);
            };

            // --- Event Listeners ---
            processBtn.addEventListener('click', async () => {
                hideError();
                const file = dataFileInput.files[0];
                if (!file) {
                    showError('Harap unggah file data Anda sebelum memproses.');
                    return;
                }
                loader.classList.remove('hidden');
                processBtn.disabled = true;
                try {
                    const dataRaw = await parseFile(file);
                    fullData = cleanData(dataRaw).sort((a,b) => b.Tanggal - a.Tanggal);
                    
                    if (fullData.length === 0) {
                        showError("Tidak ada data valid yang dapat diproses dari file yang diunggah.");
                    } else {
                        renderAdmHeatmap(fullData);
                        runFilterAndRender();
                        resultsDiv.classList.remove('hidden');
                        welcomeDiv.classList.add('hidden');
                    }
                } catch (error) {
                    showError(error.message);
                    console.error(error);
                } finally {
                    loader.classList.add('hidden');
                    processBtn.disabled = false;
                }
            });

            searchBtn.addEventListener('click', runFilterAndRender);

            resetBtn.addEventListener('click', () => {
                searchNamaInput.value = '';
                searchTanggalMulaiInput.value = '';
                searchTanggalSelesaiInput.value = '';
                searchSumberInput.value = '';
                runFilterAndRender();
            });

        });
    </script>
</body>
</html>
